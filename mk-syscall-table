#!/bin/sh
set -e
echo '/* Syscall table automatically generated by mk-syscall-table */'
echo
cat <<FOE |
#ifdef __amd64
#define CONFIG_BOX_KERNEL_AMD64
#define CONFIG_BOX_USER_AMD64
#endif
#if defined(CONFIG_BOX_KERNEL_AMD64) && !defined(CONFIG_BOX_USER_AMD64)
#include <asm/unistd_32.h>
#else
#include <asm/unistd.h>
#endif
#define FOO 1 + 2
FOE
	gcc -E -dD "$@" - |
	grep '__NR' |
	sed -e 's/#define \(.*\?\) .*/\0\n"\1" \1/' |
	gcc -E -x c - - |
	grep -v '#' |
	grep '[0-9]' |
        # i dunno why these calls still exist... oh well.
	#awk '{while("echo -n \"#define\" " $1 " \" \"; ( echo \"" $2$3 "\" | bc )" | getline) {print}}' |
	#grep '[0-9]' |
	#sed '/__NR_madvise1/d; s/^#define __NR_\([^ 	]\+\)[ 	]\+\([0-9]\+\).*/\/* \2 *\/ [ __NR_\1 ] = "\1",/;t;d' |
        sed -e 's/"__NR_\(.*\)" \(.*\)/\/* \2 *\/ [__NR_\1] = "\1",/g' |
	sort -k2 -n
